<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="https://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout1}"
>
<head>
<meta charset="UTF-8">
<title>chatMain</title>
</head>
<body>
	<!-- 스타일 부분 -->
	<th:block layout:fragment="style1">
		<style>
		/* 메인 공통 */
			#main_wrapper {
				height:1000px;
				margin-left: 5%;
				margin-top: 30px;
				margin-bottom: 50px;
			}
			#main_tab, #main_left, #main_right {
				height:100%;
			}
		
		/* 메인 탭 */
			#main_tab {
				background-color: skyblue;
				float: left;
				width: 10%
			}
		
		/* --- 메인 탭 끝 --- */
		
		/* 메인 왼쪽 창 */
			#main_left {
				background-color: lightgreen;
				float: left;
				width: 30%
			}
			#div_my_id {
			    border-bottom-color: rgb(221, 221, 221);
			    border-bottom-width: 1px !important;
			    border-bottom-style: solid !important;
			    padding-bottom: 16px;
			    padding-top: 14px;
			    padding-left: 12px;
			}
			#left_top_span_my_id {
				color: black;
   		 		font-weight: 600;
    			font-size: 20px;
			}			
			.tr_trade {
				cursor: pointer;
			}
		/* --- 메인 왼쪽 창 끝 --- */
		
		/* 메인 오른쪽 창 */
			#main_right {
				background-color: skyblue;
				float: left;
				width: 55%
			}
		/* --- 메인 오른쪽 창 끝 */
		
		/* 모달창 */
			#modal_background {
				display: none;
			    position: absolute;
			    top: 0;
			    left: 0;
			    right: 0;
			    bottom: 0;
			    content: '';
			    opacity: .3;
			    background: #000000;
				height: 200%;
				width: 100%;		
				z-index: 1;		
			}
		/* data	*/
			#data {
				display: none;
			}
		</style>
	</th:block>
	
	<!-- 메인 부분 -->
	<div class="panel panel-default" layout:fragment="content1">
		<!-- 모달창 배경 -->
		<div id="modal_background"></div>

		<!-- 상단 부분 -->
		 <section class="hero-wrap hero-wrap-2 js-myheight" style="background-image: url('/bootstrap/images/trade/chatMain.png');">
		  <div class="overlay"></div>
		  <div class="container">
		    <div class="row no-gutters slider-text js-myheight align-items-end justify-content-center">
		      <div class="col-md-9 ftco-animate pb-5 text-center">
		       <p class="breadcrumbs"><span class="mr-2"><a href="index.html">Home <i class="fa fa-chevron-right"></i></a></span> <span>채팅하기 <i class="fa fa-chevron-right"></i></span></p>
		       <h1 class="mb-0 bread">채팅하기</h1>
		     </div>
		   </div>
		 </div>
		</section>

		<!-- 메인 wrapper -->
		<div id="main_wrapper">
			<!-- 메인 탭 -->
			<div id="main_tab">
				ALL<br>
				RENT<br>
				SHARE<br>
			</div> <!-- 메인 탭 끝 -->
			
			<!-- 메인 왼쪽 -->
			<div id="main_left">
				<div id="div_my_id">
					<span id="left_top_span_my_id" th:text="${mapOfPrincipal.mNickname}"></span>
				</div>
				<div id="chat_list_wraaper">
					<br>내 아이템에 대한 거래 목록<br>
					<table>
						<tr>
							<th>거래아이템</th>
							<th>구매자아이디</th>
						</tr>
						<th:block th:each="trade : ${tradesForSharer}">
							<tr th:id="${trade.tId}" th:classappend="${('tr_trade') + (' tt')}">
								<td th:id="${trade.tId + '_iTitle'}" th:text="${trade.item.iTitle}"></td>
								<td th:id="${trade.tId + '_mId'}"th:text="${trade.buyMember.mId}"></td>
							</tr>
						</th:block>
					</table>
					
					<br>내가 신청한 거래 목록<br>
					<table>
						<tr>
							<th>거래아이템</th>
							<th>판매자아이디</th>
						</tr>
						<th:block th:each="trade : ${tradesForRenter}">
							<tr th:id="${trade.tId}" th:classappend="${('tr_trade') + (' tt')}">
								<td th:id="${trade.tId + '_iTitle'}" th:text="${trade.item.iTitle}"></td>
								<td th:id="${trade.tId + '_mId'}"th:text="${trade.item.member.mId}"></td>
							</tr>
						</th:block>
					</table>					
				</div>
			</div> <!-- 메인 왼쪽 끝-->
	
			<!-- 메인 오른쪽 -->
			<div id="main_right">
				메인 오른쪽
			</div> <!-- 메인 오른쪽 끝-->
		</div> <!-- 메인 wrapper 끝 -->
		<!-- 데이터 -->
		<div id="data">
			<input id="iId" th:value="${iId}">
		</div> <!-- 데이터 끝 -->
	</div>

	<th:block layout:fragment="script1">
		<!-- 채팅 웹소켓 관련 스크립트 -->
		<script th:inline="javascript">
			// 웹소켓 전역 변수 선언
			let wsOfChat; // 내 채팅 웹소켓 객체
			let myChatSessionId; // 내 채팅 세션 아이디
			
			// 웹 소켓 열기 함수
			function openWsOfChat(tId) {
				console.log('openWsOfChat - location.host:' + location.host + ' tId:' + tId);
				let wsUriOfChat = 'ws://' + location.host + '/chat/' + tId;
				wsOfChat = new WebSocket(wsUriOfChat);
				configWsOfChat(wsOfChat); // 웹 소켓 세팅
			}
			
			// 소켓 세팅 설정 함수 (소켓 열 때 사용)
			function configWsOfChat(ws) {
				
				// 서버에서 메시지 받았을 때
				wsOfChat.onmessage = res => {
					resObj = JSON.parse(res.data);
					
					// 채팅 소켓 연결 직후 메시지라면
					if (resObj.type == 'afterChatConnection') {
						myChatSessionId = resObj.chatSessionId; // 전역 변수에 내 채팅 세션 아이디 넣기
					}
					
					debugger;
				};
			}
			
			
			// 상단 메뉴 쪽 이미지 부분
			let divisor = 3; 
			var myHeight = function() {
				$('.js-myheight').css('height', $(window).height()/divisor);
				$('.overlay').css('height', $(window).height()/divisor);
				$(window).resize(function() {
					$('.js-myheight').css('height', $(window).height()/divisor);
					$('.overlay').css('height', $(window).height()/divisor);
				});
			};
			myHeight();
			
			// 채팅방 목록에서 채팅 클릭 이벤트
			$(document).on('click', ".tr_trade", e => {
				let tId = e.target.id.replace(/[^0-9]/g, ""); // 거래 아이디
				console.log('click event of tr_trade - tId: ' + tId);
				
				// DB에서 채팅 내용 가져와서 뿌려주기 (TODO) (콜백함수로 소켓 연결하기 넣기)
				
				// 소켓 연결하기 (TODO)
				openWsOfChat(tId);
			});


		</script>
	</th:block>
</body>
</html>