<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="https://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout1}"
>
<head>
<meta charset="UTF-8">
<title>chatMain</title>
</head>
<body>
	<!-- 스타일 부분 -->
	<th:block layout:fragment="style1">
		<style>
		/* 메인 공통 */
			#main_wrapper {
				height:1000px;
				margin-left: 5%;
				margin-top: 30px;
				margin-bottom: 50px;
			}
			#main_tab, #main_left, #main_right {
				height:100%;
				border-bottom-color: rgb(221, 221, 221);
			    border-bottom-width: 1px !important;
			    border-bottom-style: solid !important;		
				border-top-color: rgb(221, 221, 221);
			    border-top-width: 1px !important;
			    border-top-style: solid !important;					
		
			}
			.m_photo {
			    width: 60px;
			    height: 60px;
			    border-radius: 100%;
			}
		
		/* 메인 탭 */
			#main_tab {
				background-color: skyblue;
				float: left;
				width: 10%
			}
			
		
		/* --- 메인 탭 끝 --- */
		
		/* 메인 왼쪽 창 */
			#main_left {
				background-color: white;
				float: left;
				width: 25%;
			}
			#chat_list_wraaper {
			    padding-top: 20px;
			}
			.chat_list_title {
			    color: black;
			    font-weight: 600;
			    margin-bottom: 8px;
			    padding-left: 13px;
				font-size: 26px;		
			}
			.chat_list_table {
				width: 100%;
			    margin-bottom: 48px;
			}
			.chat_list_table td{
				padding: 13px 15px;
				/*
				border-bottom-color: rgb(221, 221, 221);
			    border-bottom-width: 1px !important;
			    border-bottom-style: solid !important;		
				border-top-color: rgb(221, 221, 221);
			    border-top-width: 1px !important;
			    border-top-style: solid !important;
				*/
			}
			.td_chat_list_mphoto {
			    width: 85px;
				padding-right: 0px !important;
			}
			.chat_list_mid {
				color: black;
			}
			#div_my_id {
			    border-bottom-color: rgb(221, 221, 221);
			    border-bottom-width: 1px !important;
			    border-bottom-style: solid !important;
			    padding-bottom: 16px;
			    padding-top: 14px;
			    padding-left: 12px;
			}
			#left_top_span_my_id {
				color: black;
   		 		font-weight: 600;
    			font-size: 20px;
			}			
			.tr_trade {
				cursor: pointer;
			}
			.tr_trade:hover {
				background-color: rgb(199 199 199 / 30%);
			}
		/* --- 메인 왼쪽 창 끝 --- */
		
		/* 메인 오른쪽 창 */
			#main_right {
				background-color: skyblue;
				float: left;
				width: 55%
			}
			#main_right_top {
				height: 105px;
				background-color: darkseagreen;
			}
			#main_right_middle {
				height: 495px;
				background-color: azure;
			}
			#main_right_bottom {
				height: 167px;
				background-color: sandybrown;			
			    padding-top: 18px;
    			padding-left: 11px;
			}
			.myMsg {
				text-align: right;
			}
			.otherMsg {
				
			}
		/* --- 메인 오른쪽 창 끝 */
		
		/* 모달창 */
			#modal_background {
				display: none;
			    position: absolute;
			    top: 0;
			    left: 0;
			    right: 0;
			    bottom: 0;
			    content: '';
			    opacity: .3;
			    background: #000000;
				height: 200%;
				width: 100%;		
				z-index: 1;		
			}
		/* data	*/
			#data {
				display: none;
			}
		</style>
	</th:block>
	
	<!-- 메인 부분 -->
	<div class="panel panel-default" layout:fragment="content1">
		<!-- 모달창 배경 -->
		<div id="modal_background"></div>

		<!-- 상단 부분 -->
		 <section class="hero-wrap hero-wrap-2 js-myheight" style="background-image: url('/bootstrap/images/trade/chatMain.png');">
		  <div class="overlay"></div>
		  <div class="container">
		    <div class="row no-gutters slider-text js-myheight align-items-end justify-content-center">
		      <div class="col-md-9 ftco-animate pb-5 text-center">
		       <p class="breadcrumbs"><span class="mr-2"><a href="index.html">Home <i class="fa fa-chevron-right"></i></a></span> <span>채팅하기 <i class="fa fa-chevron-right"></i></span></p>
		       <h1 class="mb-0 bread">채팅하기</h1>
		     </div>
		   </div>
		 </div>
		</section>

		<!-- 메인 wrapper -->
		<div id="main_wrapper">
			<!-- 메인 탭 -->
			<div id="main_tab">
				ALL<br>
				RENT<br>
				SHARE<br>
			</div> <!-- 메인 탭 끝 -->
			
			<!-- 메인 왼쪽 -->
			<div id="main_left">
				<div id="div_my_id">
					<span id="left_top_span_my_id" th:text="${mapOfPrincipal.mNickname}"></span>
				</div>
				<div id="chat_list_wraaper">
					<div class="chat_list_title">
						나의 물품 거래
					</div>
					<table class="chat_list_table">
						<th:block th:each="trade : ${tradesForSharer}">
							<tr th:id="${'trade_' + trade.tId}" 
								th:data-ititle="${trade.item.iTitle}"
								th:data-mid="${trade.buyMember.mNickname}"
								th:classappend="${('tr_trade') + (' tt')}">
								<td th:id="${trade.tId + '_mPhoto'}" class="td_chat_list_mphoto">
									<img th:id="${trade.tId + '_mPhoto_img'}" class="m_photo" th:src="${trade.buyMember.mPhoto}">
								</td>
								<td th:id="${trade.tId + '_info'}">
									<div th:id="${trade.tId + '_mId'}" class="chat_list_mid">
										[[${trade.buyMember.mNickname}]]
									</div>								
									<div th:id="${trade.tId + '_iTitle'}">
										[[${trade.item.iTitle}]]
									</div>

								</td>
							</tr>
						</th:block>
					</table>
					<div class="chat_list_title">
						내가 신청한 거래
					</div>
					<table class="chat_list_table">
						<th:block th:each="trade : ${tradesForRenter}">
							<tr th:id="${'trade_' + trade.tId}" 
								th:data-ititle="${trade.item.iTitle}"
								th:data-mid="${trade.buyMember.mNickname}"
								th:classappend="${('tr_trade') + (' tt')}">
								<td th:id="${trade.tId + '_mPhoto'}" class="td_chat_list_mphoto">
									<img th:id="${trade.tId + '_mPhoto_img'}" class="m_photo" th:src="${trade.item.member.mPhoto}">
								</td>
								<td th:id="${trade.tId + '_info'}">
									<div th:id="${trade.tId + '_mId'}" class="chat_list_mid">
										[[${trade.item.member.mNickname}]]
									</div>								
									<div th:id="${trade.tId + '_iTitle'}">
										[[${trade.item.iTitle}]]
									</div>

								</td>
							</tr>
						</th:block>
					</table>					
				</div>
			</div> <!-- 메인 왼쪽 끝-->
	
			<!-- 메인 오른쪽 -->
			<div id="main_right">
				<div id="main_right_top"> <!-- 채팅 메시지 상단 -->
					<div id="div_other_m_id">
						상대방 id:
						<span class="other_m_id"></span> 
					</div>
					<div id="div_other_i_title">
						물품 이름:
						<span class="other_i_title"></span> 
					</div>
				</div>
				<div id="main_right_middle"> <!-- 채팅 메시지 기록 -->
					<div id="chat_view">
					</div>
				</div>
				<div id="main_right_bottom"> <!-- 채팅 입력창 -->
					<input type="text" id="input_msg" 
						onKeypress="javascript:if(event.keyCode==13) {sendMsg();}">
					<button id="btn_input_msg" class="btn btn-primary py-1.5 px-2.5">전송</button>		
				</div>
			</div> <!-- 메인 오른쪽 끝-->
		</div> <!-- 메인 wrapper 끝 -->
		<!-- 데이터 -->
		<div id="data">
			<input id="iId" th:value="${iId}">
		</div> <!-- 데이터 끝 -->
	</div>

	<th:block layout:fragment="script1">
		<!-- 채팅 웹소켓 관련 스크립트 -->
		<script th:inline="javascript">
			// 웹소켓 전역 변수 선언
			let wsOfChat; // 내 채팅 웹소켓 객체
			let myChatSessionId; // 내 채팅 세션 아이디
			const MSG_TYPE_ME = 'myMsg';
			const MSG_TYPE_OTHER = 'otherMsg';
			
			// 웹 소켓 열기 함수
			function openWsOfChat(tId) {
				console.log('openWsOfChat - location.host:' + location.host + ' tId:' + tId);
				
				// 이미 열린 채팅 있다면 닫기
				if (wsOfChat != null && wsOfChat.readyState == 1) {
					console.log('previous connection is closed - ' + 'url: ' + wsOfChat.url);
					wsOfChat.close();
				}
				
				// 웹 소켓 열기
				let wsUriOfChat = 'ws://' + location.host + '/chat/' + tId;
				console.log('wsUriOfChat: ' + wsUriOfChat);
				wsOfChat = new WebSocket(wsUriOfChat);
				configWsOfChat(wsOfChat); // 웹 소켓 세팅
			}
			
			// 소켓 세팅 설정 함수 (소켓 열 때 사용)
			function configWsOfChat(ws) {
				// 서버에서 메시지 받았을 때
				wsOfChat.onmessage = res => {
					resObj = JSON.parse(res.data);
					
					// 채팅 소켓 연결 직후 메시지라면
					if (resObj.type == 'afterChatConnection') {
						myChatSessionId = resObj.chatSessionId; // 전역 변수에 내 채팅 세션 아이디 넣기
					}
					
					// 일반 메시지라면
					if (resObj.type == 'msg') {
						console.log('received msg: resOBj');
						insertMsg(MSG_TYPE_OTHER, resObj.content); // 채팅창에 메시지 띄우기
					}
				};
			}
			
			// 서버에 msg 보내기
			function sendMsg() {
				let content = $('#input_msg').val(); // 채팅 입력창에 적은 내용
				
				let payload = { // 웹소켓으로 보낼 내용
					type: 'msg',
					content: content // 채팅 입력창에 적은 내용
				}
				wsOfChat.send(JSON.stringify(payload));
				
				// UI 처리
				$('#input_msg').val(''); // 채팅 입력창 빈 값으로 만들기
				insertMsg(MSG_TYPE_ME, content);
				
			}
			
		</script> <!-- 채팅 웹소켓 관련 스크립트 끝 -->
		
		<!-- UI 변경 관련 -->
		<script th:inline="javascript">
			/*
			 	메시지 채팅창에 뿌리기
				@Param type: MSG_TYPE_ME('myMsg'), MSG_TYPE_OTHER('otherMsg')
			*/
			function insertMsg(type, content) {
				console.log('-- function: insertMsg');
				let htmlAdded;
				htmlAdded = '' 
					+ '<div' + ' class='+ type + '>'
					+ content
					+ '</div>';
				$('#chat_view').append(htmlAdded);
			}
		</script>
		
		<!-- 클릭 이벤트 등 -->
		<script th:inline="javascript">
			// 상단 메뉴 쪽 이미지 부분
			let divisor = 3; 
			var myHeight = function() {
				$('.js-myheight').css('height', $(window).height()/divisor);
				$('.overlay').css('height', $(window).height()/divisor);
				$(window).resize(function() {
					$('.js-myheight').css('height', $(window).height()/divisor);
					$('.overlay').css('height', $(window).height()/divisor);
				});
			};
			myHeight();
			
			// 채팅방 목록에서 거래 클릭 이벤트
			$(document).on('click', ".tr_trade", e => {
				let tId = e.target.id.replace(/[^0-9]/g, ""); // 거래 아이디
				console.log('click event of tr_trade - tId: ' + tId);
				
				// 채팅창 상단에 정보 뿌려주기
				let otherMId = $('#trade_' + tId).attr('data-mid');
				let otherITitle = $('#trade_' + tId).attr('data-ititle');
				$('.other_m_id').text(otherMId);
				$('.other_i_title').text(otherITitle);
				
				// DB에서 채팅 내용 가져와서 뿌려주기 (TODO) (콜백함수로 소켓 연결하기 넣기)
				
				// 소켓 연결하기 (TODO)
				openWsOfChat(tId);
			});
			
			// 채팅 메시지 전송 버튼 클릭 이벤트
			$(document).on('click', "#btn_input_msg", e=> {
				sendMsg();
			});

		</script>
	</th:block>
</body>
</html>