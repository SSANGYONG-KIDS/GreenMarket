<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="https://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout1}"
>
<head>
<meta charset="UTF-8">
<title>chatMain</title>
</head>
<body>
	<!-- 스타일 부분 -->
	<th:block layout:fragment="style1">
		<style>
		/* 메인 공통 */
			#main_wrapper {
			    height: 794px;
			    margin-left: 14%;
			    margin-top: 30px;
			    margin-bottom: 166px;
			}
			#main_tab, #main_left, #main_right {
				height:100%;
				/*
				border-bottom-color: rgb(221, 221, 221);
			    border-bottom-width: 1px !important;
			    border-bottom-style: solid !important;		
				*/
				border-top-color: rgb(221, 221, 221);
			    border-top-width: 1px !important;
			    border-top-style: solid !important;					
		
			}
			.m_photo {
			    width: 60px;
			    height: 60px;
			    border-radius: 100%;
			}
			.other_m_photo {
			    width: 60px;
			    height: 60px;
			    border-radius: 100%;
				float: left;
			    margin-right: 22px;
				display: none;
			}			
		
		/* 메인 탭 */
			#main_tab {
				background-color: skyblue;
				float: left;
				width: 10%;
				display: none;
			}
			
		
		/* --- 메인 탭 끝 --- */
		
		/* 메인 왼쪽 창 */
			#main_left {
				background-color: white;
				float: left;
				width: 25%;
				border-left-color: rgb(221, 221, 221);
			    border-left-width: 1px !important;
			    border-left-style: solid !important;	
				border-right-color: rgb(221, 221, 221);
			    border-right-width: 1px !important;
			    border-right-style: solid !important;		
			}
			#chat_list_wraaper {
			    padding-top: 20px;
			    overflow: scroll;
			    overflow-x: hidden;
			    height: 91%;
			}
			.chat_list_title {
			    color: black;
			    font-weight: 600;
			    margin-bottom: 8px;
			    padding-left: 13px;
				font-size: 26px;		
			}
			.chat_list_table {
				width: 100%;
			    margin-bottom: 48px;
			}
			.chat_list_table td{
				padding: 13px 15px;
				/*
				border-bottom-color: rgb(221, 221, 221);
			    border-bottom-width: 1px !important;
			    border-bottom-style: solid !important;		
				border-top-color: rgb(221, 221, 221);
			    border-top-width: 1px !important;
			    border-top-style: solid !important;
				*/
			}
			.td_chat_list_mphoto {
			    width: 85px;
				padding-right: 0px !important;
			}
			.chat_list_mid {
				color: black;
			}
			#div_my_id {
				/*
				border-bottom-color: rgb(221, 221, 221);
			    border-bottom-width: 1px !important;
			    border-bottom-style: solid !important;
				*/
			    padding-bottom: 16px;
			    padding-top: 25px;
			    padding-left: 20px;
			    height: 9%;
			}
			#left_top_span_my_id {
				color: black;
   		 		font-weight: 600;
    			font-size: 20px;
			}			
			.tr_trade {
				cursor: pointer;
			}
			.tr_trade:hover {
				background-color: rgb(199 199 199 / 30%);
			}
			.cnt_unread {
			    background-color: red;
			    color: white;
			    border-radius: 100%;
			    padding: 0px 0px;
			    font-size: 14px;
			    width: 21px;
			    text-align: center;
			    line-height: 21px;
			}
		/* --- 메인 왼쪽 창 끝 --- */
		
		/* 메인 오른쪽 창 */
			#main_right {
				background-color: white;
				float: left;
				width: 55%;
				
			}
			#main_right_top {
				height: 105px;
				background-color:white;
				padding-top: 20px;
    			padding-left: 23px;
			}
			#main_right_middle {
				height: 495px;
				background-color: white;
			}
			#main_right_bottom {
			    height: 180px;
			    background-color: white;
			    padding-top: 18px;
			    padding-left: 12px;
			    padding-right: 12px;
			    /* padding-bottom: 14px; */
			    border: 3px solid rgb(221, 221, 221);
			    margin-left: 12px;
			    border-radius: 23px;
			    text-align: right;
			}
			#chat_view {
				overflow: scroll;
    			height: 470px;
    			overflow-x: hidden;
				padding-left: 34px;
				padding-right: 18px;
			}
			.other_m_nickname {
			    font-weight: 600;
			    color: black;				
			}
			.div_other_m_id {
				display: none;
			}
			
			.myMsg, .otherMsg {
			    margin: 39px 0px;
			    margin-right: 10px;	
				position: relative;
				height: 40px;
			}
			.myMsg {
				text-align: right;
			}
			.myMsg_span, .otherMsg_span {			    
			    border-radius: 21px;
			    padding: 9px 18px;		
			}
			.myMsg_span {
				background-color: #499f74;
				color: white;
			}
			.otherMsg_span {
				background-color: rgb(221, 221, 221);
				color: black;
			}
			.myMsg_m_photo {
				display: none;
			}
			.otherMsg_m_photo {
			    width: 43px;
			    height: 43px;
			    border-radius: 100%;
			    float: left;
			    margin-right: 19px;
    			margin-top: -8.1px;		
			}
			.myMsg_msg_time {
				margin-right: 13px;
			    font-weight: 300;
			    font-size: 14px;				
			}
			.otherMsg_msg_time {
				margin-left: 13px;
			    font-weight: 300;
			    font-size: 14px;
			}
			.msg_unread {
			    color: #aab13b;
			    font-weight: 500;
			    font-size: 14px;
			}
			.msg_unread_0 {
				color: white;
			}
						
			.my_m_photo {
			    width: 43px;
			    height: 43px;
			    border-radius: 100%;
			    float: left;
			    margin-right: 17px;
    			margin-top: -5.1px;						
			}

			#input_msg {
				border: none;
			    width: 100%;
				height: 56%;
				resize: none;
				padding: 8px;
			}
			#btn_input_msg {
			    text-align: right;
			    margin-top: 12px;
			    margin-right: 15px;				
			}
			
			.div_msg_unread {
			    margin-bottom: -12px;
			    margin-right: 13px;				
			}
			
			.div_myMsg_msg_time {
				
			}
			
			.wrapper_msg_info_myMsg {
				float: right;
    			margin-top: -7.6px;
				margin-right: 0px;
			}
			
			.wrapper_msg_info_otherMsg {
				float: left;
    			margin-top: -7.6px;
				margin-left: 0px;				
			}
			
			.div_myMsg_span {
				float: right;
			}
			.div_otherMsg_span {
				float: left;
			}
		/* --- 메인 오른쪽 창 끝 */
		
		/* 모달창 */
			#modal_background {
				display: none;
			    position: absolute;
			    top: 0;
			    left: 0;
			    right: 0;
			    bottom: 0;
			    content: '';
			    opacity: .3;
			    background: #000000;
				height: 200%;
				width: 100%;		
				z-index: 1;		
			}
		/* data	*/
			#data {
				display: none;
			}
		</style>
	</th:block>
	
	<!-- 메인 부분 -->
	<div class="panel panel-default" layout:fragment="content1">
		<!-- 모달창 배경 -->
		<div id="modal_background"></div>

		<!-- 상단 부분 -->
		 <section class="hero-wrap hero-wrap-2 js-myheight" style="background-image: url('/bootstrap/images/trade/chatMain.png');">
		  <div class="overlay"></div>
		  <div class="container">
		    <div class="row no-gutters slider-text js-myheight align-items-end justify-content-center">
		      <div class="col-md-9 ftco-animate pb-5 text-center">
		       <p class="breadcrumbs"><span class="mr-2"><a href="/">Home <i class="fa fa-chevron-right"></i></a></span> <span>Message <i class="fa fa-chevron-right"></i></span></p>
		       <h1 class="mb-0 bread">채팅하기</h1>
		     </div>
		   </div>
		 </div>
		</section>

		<!-- 메인 wrapper -->
		<div id="main_wrapper">
			<!-- 메인 탭 -->
			<div id="main_tab">
				ALL<br>
				RENT<br>
				SHARE<br>
			</div> <!-- 메인 탭 끝 -->
			
			<!-- 메인 왼쪽 -->
			<div id="main_left">
				<div id="div_my_id">
					<img class="my_m_photo" th:src="${mapOfPrincipal.mPhoto}">
					<span id="left_top_span_my_id" th:text="${mapOfPrincipal.mNickname}"></span>
				</div>
				<div id="chat_list_wraaper">
					<div class="chat_list_title">
						나의 물품 거래
					</div>
					<table class="chat_list_table">
						<th:block th:each="trade, i : ${tradesForSharer}">
							<tr th:id="${'trade_' + trade.tId}" 
								th:data-ititle="${trade.item.iTitle}"
								th:data-mid="${trade.buyMember.mId}"
								th:data-mnickname="${trade.buyMember.mNickname}"
								th:data-mphoto="${trade.buyMember.mPhoto}"
								th:classappend="${('tr_trade') + (' tt')}">
								<td th:id="${trade.tId + '_mPhoto'}" class="td_chat_list_mphoto">
									<img th:id="${trade.tId + '_mPhoto_img'}" class="m_photo" th:src="${trade.buyMember.mPhoto}">
								</td>
								<td th:id="${trade.tId + '_info'}">
									<div th:id="${trade.tId + '_mId'}" class="chat_list_mid">
										[[${trade.buyMember.mNickname}]]
									</div>								
									<div th:id="${trade.tId + '_iTitle'}">
										[[${trade.item.iTitle}]]
									</div>
								</td>
								<td th:id="${'td_' + trade.tId + '_cntUnread'}">
									<div th:id="${'div_' + trade.tId + '_cntUnread'}" class="cnt_unread"
										 th:if="${cntsUnreadForSharer[i.index] > 0}" th:text="${cntsUnreadForSharer[i.index]}">
									</div>
								</td>
							</tr>
						</th:block>
					</table>
					<div class="chat_list_title">
						내가 신청한 거래
					</div>
					<table class="chat_list_table">
						<th:block th:each="trade, i : ${tradesForRenter}">
							<tr th:id="${'trade_' + trade.tId}" 
								th:data-ititle="${trade.item.iTitle}"
								th:data-mid="${trade.item.member.mId}"
								th:data-mnickname="${trade.item.member.mNickname}"
								th:data-mphoto="${trade.item.member.mPhoto}"
								th:classappend="${('tr_trade') + (' tt')}">
								<td th:id="${trade.tId + '_mPhoto'}" class="td_chat_list_mphoto">
									<img th:id="${trade.tId + '_mPhoto_img'}" class="m_photo" th:src="${trade.item.member.mPhoto}">
								</td>
								<td th:id="${trade.tId + '_info'}">
									<div th:id="${trade.tId + '_mId'}" class="chat_list_mid">
										[[${trade.item.member.mNickname}]]
									</div>								
									<div th:id="${trade.tId + '_iTitle'}">
										[[${trade.item.iTitle}]]
									</div>
								</td>
								<td th:id="${'td_' + trade.tId + '_cntUnread'}">
									<div th:id="${'div_' + trade.tId + '_cntUnread'}" class="cnt_unread"
										 th:if="${cntsUnreadForRenter[i.index] > 0}" th:text="${cntsUnreadForRenter[i.index]}">
									</div>
								</td>							
							</tr>
						</th:block>
					</table>					
				</div>
			</div> <!-- 메인 왼쪽 끝-->
	
			<!-- 메인 오른쪽 -->
			<div id="main_right">
				<div id="main_right_top"> <!-- 채팅 메시지 상단 -->
					<img class="other_m_photo" src="">
					<div id="div_other_m_nickname">
						<span class="other_m_nickname"></span> 
					</div>
					<div id="div_other_i_title">
						<span class="other_i_title"></span> 
					</div>
					<div id="div_other_m_id">
						<span class="other_m_id"></span> 
					</div>					
				</div>
				<div id="main_right_middle"> <!-- 채팅 메시지 기록 -->
					<div id="chat_view">
					</div>
				</div>
				<div id="main_right_bottom"> <!-- 채팅 입력창 -->
					<textarea type="text" id="input_msg" placeholder="메세지를 입력해주세요."
						onKeypress="javascript:if(event.keyCode==13) {preventMoving(event); sendMsg();}"></textarea>
					<button id="btn_input_msg" class="btn btn-primary py-1.5 px-2.5">전송</button>		
				</div>
			</div> <!-- 메인 오른쪽 끝-->
		</div> <!-- 메인 wrapper 끝 -->
		<!-- 데이터 -->
		<div id="data">
			<input id="iId" type="hidden" th:value="${iId}">
			<input id="principalMId" type="hidden" th:value="${mapOfPrincipal.mId}">
			<input id="is_chat_main" type="hidden" value="true">
		</div> <!-- 데이터 끝 -->
	</div>

	<th:block layout:fragment="script1">
		<!-- 메인 상단 메뉴 active -->
		<script>
			$('#nav-item-message').addClass('active');			
		</script>
		<!-- UI 변경 관련 -->
		<script th:inline="javascript">

			
			/*
			 	메시지 채팅창에 뿌리기
				@Param type: MSG_TYPE_ME('myMsg'), MSG_TYPE_OTHER('otherMsg')
			*/
			function insertMsg(type, content, time, isUnread) {
				if (isUnread == null) isUnread = 0;
				let htmlAdded;
	
				htmlAdded = '' // 하나의 메시지
					+ '<div class="'+ type + '">';
					
				if (type == MSG_TYPE_OTHER) { // 상대방 프로필 이미지
					htmlAdded += ''	
					+ 	'<img class="' + type + '_m_photo" src="' + otherMPhoto + '">';					
				}
				
				htmlAdded += ''	// 메시지
					+ 	'<div class="div_' + type + '_span">'
					+		'<span class="' + type + '_span">'
					+ 			content
					+		'</span>'
					+	'</div>';

				htmlAdded += '' // 읽은 여부, 시간 wrapper
				+		'<div class="wrapper_msg_info_'+ type + '">';
				
				htmlAdded += '' // 내 메시지 읽은 여부
				+			'<div class="div_msg_unread">'
				+				'<span class= "msg_unread msg_unread_' + isUnread + '">'
				+ 					isUnread
				+				'</span>'
				+ 			'</div>';
				
				htmlAdded += ''	// 메시지 시간
				+			'<div class="div_'+ type + '_msg_time">'
				+				'<span class="' + type + '_msg_time">'
				+					time
				+				'</span>'
				+			'</div>';					
						
				htmlAdded += '' // 읽은 여부, 시간 wrapper 끝
				+		'</div>'; 
				
				htmlAdded += '' // 하나의 메시지 끝
				+ 	'</div>'; 
				
				// DOM 변경
				$('#chat_view').append(htmlAdded);
				$('#chat_view').scrollTop($('#chat_view').prop('scrollHeight')); // 스크롤바 최하단으로 내리기
			}
			
			
			/*
				모든 메시지 읽음 처리하기 (모든 메시지에 1 제거)
			*/
			function changeViewToReadState() {
				// msg_unread_1 -> msg_unread_0 으로 변경
				$('.msg_unread_1').addClass('msg_unread_0');
				$('.msg_unread_0').removeClass('msg_unread_1');
			}
			
			/*
				안읽은 메시지 1증가하기
			*/
			function addUnreadCnt(anotherTId) {
				let anotherCntUnreadTd = $('#td_'+ anotherTId + '_cntUnread'); // 메시지 온 방 안읽은 메시지 td
				let anotherCntUnreadDiv = $('#div_'+ anotherTId + '_cntUnread'); // 메시지 온 방 안읽은 메시지 div
				
				// 해당 방에 이미 안읽은 메시지 div 있는 경우 1 추가
				if (anotherCntUnreadDiv.length > 0) {
					anotherCntUnreadDiv.text(Number(anotherCntUnreadDiv.text()) + 1);
					
					// display none인 경우 block으로 보이게 하기
					if (anotherCntUnreadDiv.css('display') == 'none') {
						anotherCntUnreadDiv.css('display', 'block');
					};
				}
				
				// 해당 방에 안읽은 메시지 div 없는 경우 div 추가
				else if (anotherCntUnreadDiv.length == 0) {
					let htmlAdded;
					htmlAdded = ''
					+ '<div id="div_' + anotherTId + '_cntUnread" class="cnt_unread">'
					+ 	1
					+ '</div>';
					anotherCntUnreadTd.append(htmlAdded);
				}				
			}
		</script>
		
		<!-- 클릭 이벤트 등 -->
		<script th:inline="javascript">
			// 상단 메뉴 쪽 이미지 부분
			let divisor = 3; 
			var myHeight = function() {
				$('.js-myheight').css('height', $(window).height()/divisor);
				$('.overlay').css('height', $(window).height()/divisor);
				$(window).resize(function() {
					$('.js-myheight').css('height', $(window).height()/divisor);
					$('.overlay').css('height', $(window).height()/divisor);
				});
			};
			myHeight();
			
			// 채팅방 목록에서 거래 클릭 이벤트
			let	otherMId;
			let otherMNickname;
			let otherITitle;
			let otherMPhoto;
			$(document).on('click', ".tr_trade", e => {
				let tId = e.target.id.replace(/[^0-9]/g, ""); // 거래 아이디
				
				// 이전 채팅방 채팅 기록 내용 지우기
				$('#chat_view').html('');
				
				// 채팅창 상단에 정보 뿌려주기
				otherMId = $('#trade_' + tId).attr('data-mid');
				otherMNickname = $('#trade_' + tId).attr('data-mnickname');
				otherITitle = $('#trade_' + tId).attr('data-ititle');
				otherMPhoto = $('#trade_' + tId).attr('data-mphoto');
				$('.other_m_nickname').text(otherMNickname);
				$('.other_i_title').text(otherITitle);
				$('.other_m_photo').attr('src', otherMPhoto);
				$('.other_m_photo').css('display', 'block');
				
				// DB에서 채팅 내용 가져와서 뿌려주기
				showChatInDb(tId, openWsOfChat); // openWsOfChat은 콜백함수
				
				// 안읽은 메시지 UI 반영하기 (지우거나 감소)
				let divCntUnread = $('#div_' + tId + '_cntUnread');
				let cntOfDivCntUnread = divCntUnread.text();
				if (divCntUnread.length > 0 && Number(cntOfDivCntUnread) > 0) { // 채팅 메인 왼쪽 안읽은 메시지 UI
					divCntUnread.text(0);
					divCntUnread.css('display', 'none');
				}
				addUnreadCntOnMenu(-cntOfDivCntUnread); // 메뉴 상단에 안읽은 메시지 UI
			});
			
			// 채팅 메시지 전송 버튼 클릭 이벤트
			$(document).on('click', "#btn_input_msg", e=> {
				sendMsg();
			});
		</script>
		
		<!-- 기타 함수 추가 -->
		<script>
			// 엔터 줄바꿈 막기
			function preventMoving(event){
				if(event.keyCode == 13) {
			    	event.preventDefault(); 
			    }
			}
 
		
			// 커서 이동
			$.fn.selectRange = function(start, end) {			
			    return this.each(function() {
			         if(this.setSelectionRange) {
			             this.focus();
			             this.setSelectionRange(start, end);
			         } else if(this.createTextRange) {
			             var range = this.createTextRange();
			             range.collapse(true);
			             range.moveEnd('character', end);
			             range.moveStart('character', start);
			             range.select();
			         }
			     });			
			 };		
		</script>
	</th:block>
</body>
</html>